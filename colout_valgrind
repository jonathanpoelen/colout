#!/usr/bin/awk -f

# ./mk_theme.sh valgrind \
# '^(==[0-9]+==\s{1})(Memcheck|Copyright|Using|Rerun|Use --)(.*)$' 'b' -- \
# '^(==[0-9]+==\s{1})(Warning)(.*)$' 'm' -- \
# '^(==[0-9]+==\s{1}Command: )(\S*).*$' 'g' 'W' -- \
# '^(==[0-9]+==\s{1})(HEAP SUMMARY:|All heap blocks were freed)(.*)$' 'g' -- \
# '^(==[0-9]+==\s{1}\S+.*)$' 'r' -- \
# '^==[0-9]+==\s{2}(\S+.*)$' 'y' -- \
# '^==[0-9]+==\s{4}([atby]{2}) (0x0): (\?{3})' 'b' 'y' 'R' -- \
# '^==[0-9]+==\s{4}([atby]{2}) (0x)([^:]*:) \S+' 'b' -- \
# '\(in (.*)\)' 'c' -- \
# '\(([^\.]*\.[^:]+):([0-9]+)\)' 'W' 'y' -- \
# '^==[0-9]+==\s{4}(definitely lost): .* (in) .*' 'R' -- \
# '^==[0-9]+==\s{4}(indirectly lost): .* (in) .*' 'Y' -- \
# '^==[0-9]+==\s{6}(possibly lost): .* (in) .*' 'Y' -- \
# '^==[0-9]+==\s{4}(still reachable): .* (in) .*' 'G' -- \
# '^==[0-9]+==\s{9}(suppressed): .* (in) .*' 'C'

# gawk profile, created Mon Feb 20 23:50:31 2017

# BEGIN rule(s)

BEGIN {
	colors2[0] = ";32"
	colors2[1] = ";97;1"
	nb_colors2 = 2
	colors6[0] = ";34"
	colors6[1] = ";33"
	colors6[2] = ";31;1"
	nb_colors6 = 3
	colors9[0] = ";97;1"
	colors9[1] = ";33"
	nb_colors9 = 2
}

# Rule(s)

{
	s = ""
	if (match($0, /^(==[0-9]+==\s{1})(Memcheck|Copyright|Using|Rerun|Use --)(.*)$/, a)) {
		n = length(a) / 3
		if (n == 1) {
			i = 0
			ic = 0
			s = s substr($0, 0, RSTART - 1) "\033[;34m" a[i] "\033[0m"
		} else {
			c = ""
			p = 1
			for (i = 1; i < n; ++i) {
				start = a[i, "start"]
				if (start == null) {
					++n
					continue
				}
				ic = i - 1
				s = s substr($0, p, start - p) "\033[;34m" a[i] "\033[0m"
				p = start + a[i, "length"]
			}
			s = s substr($0, p, RSTART + RLENGTH - p)
		}
		$0 = substr($0, RLENGTH + RSTART)
	} else {
		if (match($0, /^(==[0-9]+==\s{1})(Warning)(.*)$/, a)) {
			n = length(a) / 3
			if (n == 1) {
				i = 0
				ic = 0
				s = s substr($0, 0, RSTART - 1) "\033[;35m" a[i] "\033[0m"
			} else {
				c = ""
				p = 1
				for (i = 1; i < n; ++i) {
					start = a[i, "start"]
					if (start == null) {
						++n
						continue
					}
					ic = i - 1
					s = s substr($0, p, start - p) "\033[;35m" a[i] "\033[0m"
					p = start + a[i, "length"]
				}
				s = s substr($0, p, RSTART + RLENGTH - p)
			}
			$0 = substr($0, RLENGTH + RSTART)
		} else {
			if (match($0, /^(==[0-9]+==\s{1}Command: )(\S*).*$/, a)) {
				n = length(a) / 3
				if (n == 1) {
					i = 0
					ic = 0
					s = s substr($0, 0, RSTART - 1) "\033[" colors2[ic % nb_colors2] "m" a[i] "\033[0m"
				} else {
					c = ""
					p = 1
					for (i = 1; i < n; ++i) {
						start = a[i, "start"]
						if (start == null) {
							++n
							continue
						}
						ic = i - 1
						s = s substr($0, p, start - p) "\033[" colors2[ic % nb_colors2] "m" a[i] "\033[0m"
						p = start + a[i, "length"]
					}
					s = s substr($0, p, RSTART + RLENGTH - p)
				}
				$0 = substr($0, RLENGTH + RSTART)
			} else {
				if (match($0, /^(==[0-9]+==\s{1})(HEAP SUMMARY:|All heap blocks were freed)(.*)$/, a)) {
					n = length(a) / 3
					if (n == 1) {
						i = 0
						ic = 0
						s = s substr($0, 0, RSTART - 1) "\033[;32m" a[i] "\033[0m"
					} else {
						c = ""
						p = 1
						for (i = 1; i < n; ++i) {
							start = a[i, "start"]
							if (start == null) {
								++n
								continue
							}
							ic = i - 1
							s = s substr($0, p, start - p) "\033[;32m" a[i] "\033[0m"
							p = start + a[i, "length"]
						}
						s = s substr($0, p, RSTART + RLENGTH - p)
					}
					$0 = substr($0, RLENGTH + RSTART)
				} else {
					if (match($0, /^(==[0-9]+==\s{1}\S+.*)$/, a)) {
						n = length(a) / 3
						if (n == 1) {
							i = 0
							ic = 0
							s = s substr($0, 0, RSTART - 1) "\033[;31m" a[i] "\033[0m"
						} else {
							c = ""
							p = 1
							for (i = 1; i < n; ++i) {
								start = a[i, "start"]
								if (start == null) {
									++n
									continue
								}
								ic = i - 1
								s = s substr($0, p, start - p) "\033[;31m" a[i] "\033[0m"
								p = start + a[i, "length"]
							}
							s = s substr($0, p, RSTART + RLENGTH - p)
						}
						$0 = substr($0, RLENGTH + RSTART)
					} else {
						if (match($0, /^==[0-9]+==\s{2}(\S+.*)$/, a)) {
							n = length(a) / 3
							if (n == 1) {
								i = 0
								ic = 0
								s = s substr($0, 0, RSTART - 1) "\033[;33m" a[i] "\033[0m"
							} else {
								c = ""
								p = 1
								for (i = 1; i < n; ++i) {
									start = a[i, "start"]
									if (start == null) {
										++n
										continue
									}
									ic = i - 1
									s = s substr($0, p, start - p) "\033[;33m" a[i] "\033[0m"
									p = start + a[i, "length"]
								}
								s = s substr($0, p, RSTART + RLENGTH - p)
							}
							$0 = substr($0, RLENGTH + RSTART)
						} else {
							if (match($0, /^==[0-9]+==\s{4}([atby]{2}) (0x0): (\?{3})/, a)) {
								n = length(a) / 3
								if (n == 1) {
									i = 0
									ic = 0
									s = s substr($0, 0, RSTART - 1) "\033[" colors6[ic % nb_colors6] "m" a[i] "\033[0m"
								} else {
									c = ""
									p = 1
									for (i = 1; i < n; ++i) {
										start = a[i, "start"]
										if (start == null) {
											++n
											continue
										}
										ic = i - 1
										s = s substr($0, p, start - p) "\033[" colors6[ic % nb_colors6] "m" a[i] "\033[0m"
										p = start + a[i, "length"]
									}
									s = s substr($0, p, RSTART + RLENGTH - p)
								}
								$0 = substr($0, RLENGTH + RSTART)
							} else {
								if (match($0, /^==[0-9]+==\s{4}([atby]{2}) (0x)([^:]*:) \S+/, a)) {
									n = length(a) / 3
									if (n == 1) {
										i = 0
										ic = 0
										s = s substr($0, 0, RSTART - 1) "\033[;34m" a[i] "\033[0m"
									} else {
										c = ""
										p = 1
										for (i = 1; i < n; ++i) {
											start = a[i, "start"]
											if (start == null) {
												++n
												continue
											}
											ic = i - 1
											s = s substr($0, p, start - p) "\033[;34m" a[i] "\033[0m"
											p = start + a[i, "length"]
										}
										s = s substr($0, p, RSTART + RLENGTH - p)
									}
									$0 = substr($0, RLENGTH + RSTART)
								} else {
									if (match($0, /\(in (.*)\)/, a)) {
										n = length(a) / 3
										if (n == 1) {
											i = 0
											ic = 0
											s = s substr($0, 0, RSTART - 1) "\033[;36m" a[i] "\033[0m"
										} else {
											c = ""
											p = 1
											for (i = 1; i < n; ++i) {
												start = a[i, "start"]
												if (start == null) {
													++n
													continue
												}
												ic = i - 1
												s = s substr($0, p, start - p) "\033[;36m" a[i] "\033[0m"
												p = start + a[i, "length"]
											}
											s = s substr($0, p, RSTART + RLENGTH - p)
										}
										$0 = substr($0, RLENGTH + RSTART)
									} else {
										if (match($0, /\(([^\.]*\.[^:]+):([0-9]+)\)/, a)) {
											n = length(a) / 3
											if (n == 1) {
												i = 0
												ic = 0
												s = s substr($0, 0, RSTART - 1) "\033[" colors9[ic % nb_colors9] "m" a[i] "\033[0m"
											} else {
												c = ""
												p = 1
												for (i = 1; i < n; ++i) {
													start = a[i, "start"]
													if (start == null) {
														++n
														continue
													}
													ic = i - 1
													s = s substr($0, p, start - p) "\033[" colors9[ic % nb_colors9] "m" a[i] "\033[0m"
													p = start + a[i, "length"]
												}
												s = s substr($0, p, RSTART + RLENGTH - p)
											}
											$0 = substr($0, RLENGTH + RSTART)
										} else {
											if (match($0, /^==[0-9]+==\s{4}(definitely lost): .* (in) .*/, a)) {
												n = length(a) / 3
												if (n == 1) {
													i = 0
													ic = 0
													s = s substr($0, 0, RSTART - 1) "\033[;31;1m" a[i] "\033[0m"
												} else {
													c = ""
													p = 1
													for (i = 1; i < n; ++i) {
														start = a[i, "start"]
														if (start == null) {
															++n
															continue
														}
														ic = i - 1
														s = s substr($0, p, start - p) "\033[;31;1m" a[i] "\033[0m"
														p = start + a[i, "length"]
													}
													s = s substr($0, p, RSTART + RLENGTH - p)
												}
												$0 = substr($0, RLENGTH + RSTART)
											} else {
												if (match($0, /^==[0-9]+==\s{4}(indirectly lost): .* (in) .*/, a)) {
													n = length(a) / 3
													if (n == 1) {
														i = 0
														ic = 0
														s = s substr($0, 0, RSTART - 1) "\033[;33;1m" a[i] "\033[0m"
													} else {
														c = ""
														p = 1
														for (i = 1; i < n; ++i) {
															start = a[i, "start"]
															if (start == null) {
																++n
																continue
															}
															ic = i - 1
															s = s substr($0, p, start - p) "\033[;33;1m" a[i] "\033[0m"
															p = start + a[i, "length"]
														}
														s = s substr($0, p, RSTART + RLENGTH - p)
													}
													$0 = substr($0, RLENGTH + RSTART)
												} else {
													if (match($0, /^==[0-9]+==\s{6}(possibly lost): .* (in) .*/, a)) {
														n = length(a) / 3
														if (n == 1) {
															i = 0
															ic = 0
															s = s substr($0, 0, RSTART - 1) "\033[;33;1m" a[i] "\033[0m"
														} else {
															c = ""
															p = 1
															for (i = 1; i < n; ++i) {
																start = a[i, "start"]
																if (start == null) {
																	++n
																	continue
																}
																ic = i - 1
																s = s substr($0, p, start - p) "\033[;33;1m" a[i] "\033[0m"
																p = start + a[i, "length"]
															}
															s = s substr($0, p, RSTART + RLENGTH - p)
														}
														$0 = substr($0, RLENGTH + RSTART)
													} else {
														if (match($0, /^==[0-9]+==\s{4}(still reachable): .* (in) .*/, a)) {
															n = length(a) / 3
															if (n == 1) {
																i = 0
																ic = 0
																s = s substr($0, 0, RSTART - 1) "\033[;32;1m" a[i] "\033[0m"
															} else {
																c = ""
																p = 1
																for (i = 1; i < n; ++i) {
																	start = a[i, "start"]
																	if (start == null) {
																		++n
																		continue
																	}
																	ic = i - 1
																	s = s substr($0, p, start - p) "\033[;32;1m" a[i] "\033[0m"
																	p = start + a[i, "length"]
																}
																s = s substr($0, p, RSTART + RLENGTH - p)
															}
															$0 = substr($0, RLENGTH + RSTART)
														} else {
															if (match($0, /^==[0-9]+==\s{9}(suppressed): .* (in) .*/, a)) {
																n = length(a) / 3
																if (n == 1) {
																	i = 0
																	ic = 0
																	s = s substr($0, 0, RSTART - 1) "\033[;36;1m" a[i] "\033[0m"
																} else {
																	c = ""
																	p = 1
																	for (i = 1; i < n; ++i) {
																		start = a[i, "start"]
																		if (start == null) {
																			++n
																			continue
																		}
																		ic = i - 1
																		s = s substr($0, p, start - p) "\033[;36;1m" a[i] "\033[0m"
																		p = start + a[i, "length"]
																	}
																	s = s substr($0, p, RSTART + RLENGTH - p)
																}
																$0 = substr($0, RLENGTH + RSTART)
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
	}
	print s $0
}

